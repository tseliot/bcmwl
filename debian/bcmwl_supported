#!/bin/sh

set -e

# This is a nasty kluge, but it seems to work. Better check the output when
# upgrading to a new release of the bcmwl driver, though.

[ -n "$1" ] || {
  echo "USAGE: $0 path/to/bcmwl/wlc_hybrid.o bcmwl" >&2
  exit 1
}

echo "# Listing generated by bcmwl_supported. Do not edit manually."

device_ids() {
	local filename="$1"
	grep PCI_VENDOR_ID_BROADCOM, $filename |
	while read line; do
		id=${line#*, }
		id=${id%%,*}
		id=${id#*0x}
		echo $id
	done
}


seen_ids=' '

while [ -n "$1" ]; do
  filename="$1"; shift
  modname="$1";  shift
  pkgname="$1";  shift

  orig_ids="$(device_ids "$filename")"
  if [ -z "$orig_ids" ]; then
    echo "WARNING: No IDs were found from $filename" >&2
  fi

  for id in $orig_ids; do
    case "$seen_ids" in
      *" $id "*)
        # Already seen the ID.
        ;;
      *)
        # Not seen it yet.
        seen_ids="${seen_ids}${id} "

        printf "alias pci:v%08Xd%08Xsv*sd*bc*sc*i* %s %s\n" \
          0x14E4 "0x$id" "$modname" "$pkgname"
        ;;
    esac
  done
done | sort


